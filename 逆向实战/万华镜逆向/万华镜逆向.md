---
title: ä¸‡åé•œé€†å‘
date: 2024-03-03 15:03:39
tags:
password: md5(wtf?do_you_want_my_passwd???!!!nonono!!!)
---

æ…¢æ…¢ç£¨å§... x32dbgå†å¼€ä¸€æ¬¡
ç¬¬ä¸€éç†Ÿæ‚‰äº†å¤§æ¦‚æµç¨‹ æ¥ä¸‹æ¥å°±æ˜¯é€æ­¥å®Œå–„ç»†èŠ‚

å‡½æ•°æ²¡æœ‰ä»»ä½•éš¾ç‚¹ éš¾çš„åœ¨äºå„ä¸ªç»“æ„ä½“çš„ç»“æ„ä»¥åŠåç§»é‡ï¼ï¼ï¼
è¿˜æœ‰å‡½æ•°å±‚æ¬¡å…³ç³»...

IDAå’Œx32dbgçš„baseæ˜¯ä¸€æ ·çš„ äº’ç›¸ç…§ç€çœ‹æ–¹ä¾¿~

ç¬‘æ­» å…ˆå‰é€†çš„æ˜¯2... æ•™ç¨‹ç”¨çš„2.2... åˆä¸‹äº†ä¸€ä¸ª ç¡®å®å„ä¸ªæ•°æ®åº”è¯¥éƒ½èƒ½å¯¹ä¸Šäº†


# å‡ ä¸ªå…³é”®ç»“æ„ä½“

## FilePackVer

åœ°å€: 
ç»“æ„:
46 69 6C 65 50 61 63 6B 56 65 72 33 2E 31 00 00 
12 00 00 00 35 01 4D 02 00 00 00 00

```c++
struct FilePack{
    char sign[0x10];
    DWORD size;
    QWORD EntryPoint;
}
```

## HashData

ç»“æ„:

```c++
struct HashData{
    char sign[0x20]; //8hr...
    DWORD offset; // 028D
    char data[0x100]; //256å­—èŠ‚æ•°æ®
    DWORD unk; //å…ˆå‰æ£€éªŒdataåä¸€ä¸ªå­—èŠ‚ <0||>8å°±è®¾ç½®ä¸º0
    char Blank[0x2F8] //ç©ºå­—èŠ‚å ä½
    FilePack filepack; // FilePackç»“æ„ä½“
}
```

## HashVer

åœ°å€: 0296C5B0
ç»“æ„:
48 61 73 68 56 65 72 31 2E 34 00 00 00 00 00 00 
00 01 00 00 12 00 00 00 48 00 00 00 49 02 00 00 
01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 BE 77 EB 74 8E 27 A8 8B A1 45 8E A6

```c++
struct HashVer{
    char sign[0x10]; // HashVer1.4
    DWORD table_size;  // 100h å¯èƒ½æ˜¯è¡¨çš„å¤§å°???
    DWORD file_cnt; // 12h
    DWORD unk; // 48h
    DWORD dataSize; // 249h
    DWORD signal; // æ ‡å¿—ä½ 1 åˆ™decrypt2
    ...
    char data[0x249]; // åŠ å¯†çš„æ•°æ®
}
```

## Decrypt2DataHead

åœ°å€: 028D8120
ç»“æ„:

```c++
struct Decrypt2DataHead{
    DWORD sign; //FF435031
    DWORD isWord; // 1:unsigned __int16
    DWORD size; // 922h
}
```

## FileEntry

ç»“æ„:

```c++
struct FileEntry{
    QWORD offset; // DWORD2:DWORD1
    DWORD size;
    DWORD decrypted_size; // è§£å¯†åçš„size
    DWORD isCompressed; // 0/1 æ ‡å¿—ä½
    DWORD unk;
}
```

# è¿‘æœˆ2 æµç¨‹æ¢³ç†

## FilePack

![img](ä¸‡åé•œé€†å‘/images/image.png)
æ³¨æ„æŠŠ setfilepointeræ‰“å¼€!!! è¿™é‡Œè®¾ç½®æ–‡ä»¶æŒ‡é’ˆæ˜¯è®¾ç½®æºæ–‡ä»¶çš„ ä¹Ÿå°±æ˜¯data0.packçš„åœ°å€
çœ‹æ—¥å¿—

```
è®¾ç½®æ–‡ä»¶æŒ‡é’ˆ  å¥æŸ„:370 åç§»é‡:00  åŸºå‡†:2
è®¾ç½®æ–‡ä»¶æŒ‡é’ˆ  å¥æŸ„:370 åç§»é‡:00  åŸºå‡†:0
è®¾ç½®æ–‡ä»¶æŒ‡é’ˆ  å¥æŸ„:370 åç§»é‡:024D0DE0  åŸºå‡†:0
è¯»å–æ–‡ä»¶:  å¥æŸ„:370 ç¼“å†²:19FAF7 å­—èŠ‚æ•°:1C
```

è¯»å–çš„å°±æ˜¯æ–‡ä»¶æœ€æœ«çš„0x1Cå­—èŠ‚æ•°æ®
![img](ä¸‡åé•œé€†å‘/images/image-1.png)
ç»“åˆå‰é¢èµ°å¼¯è·¯é€†é”™æ–‡ä»¶çš„ç»éªŒ å¯ä»¥åˆ†æå‡ºå¤§è‡´ç»“æ„
å¼€å¤´çš„æ˜¯`FilePack`çš„ç­¾å åé¢`12 00 00 00` åº”è¯¥æ˜¯sizeä¹‹ç±»çš„
ç„¶åçš„ `35 01 4D 02` è·Ÿå³è¾¹çš„offsetå¾ˆåƒ æ‰€ä»¥åº”è¯¥æ˜¯æŸä¸ªå…¥å£ç‚¹çš„æŒ‡é’ˆ æœ€åä¸€ä¸ªDWORDçš„0ä¸çŸ¥é“ä»€ä¹ˆå«ä¹‰

```c++
struct FilePack{
    char sign[0x10]; // version
    DWORD size; // ? unsure of which
    DWORD EntryAddress; // probably
    DOWRD unknown; // 0?
}
```

è¿”å›x32dbg è·³å‡ºè¿™ä¸ªå‡½æ•° æŠŠä¸Šä¸‹çš„å‡½æ•°å€ŸåŠ©IDAå†™ä¸Šæ ‡ç­¾ä¾¿äºè¯†åˆ«
![img](ä¸‡åé•œé€†å‘/images/image-2.png)
æ³¨æ„åˆ°å–äº†å‰0x10 æ¥éªŒç­¾

### æ–‡ä»¶è¯»å–åˆå§‹åŒ–

æ­¥è¿›æ–‡ä»¶è¯»å–åˆå§‹åŒ–çš„å‡½æ•°é‡Œ
IDAå¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹æ¸…å‡½æ•°ç»“æ„ å…³æ³¨SetPointçš„æ—¥å¿—
`è®¾ç½®æ–‡ä»¶æŒ‡é’ˆ  å¥æŸ„:370 åç§»é‡:024D09BC  åŸºå‡†:0`
ç„¶ååé¢Read ç»§ç»­çœ‹æ—¥å¿—
`è¯»å–æ–‡ä»¶:  å¥æŸ„:370 ç¼“å†²:19F684 å­—èŠ‚æ•°:440`
è·Ÿè¸ªå‡ºæ¥å‘ç°ç¡®å®ä»data0.pack `024D09BC`å¤„è¯»å–äº†440(0x124)å­—èŠ‚æ•°æ®
å…¶å®å¾€ä¸Šç¿»ç¿»å¯ä»¥å‘ç°è¿™ä¸ªåœ¨ä¸€ä¸ªå¼€å¤´ä¸º `HashVer1.4`çš„ç»“æ„ä½“çš„æœ€æœ«

Readè¿‡ååšäº†ä¸€ä¸ªæ¯”è¾ƒå¥‡æ€ªçš„check: æ£€æŸ¥æ£€æŸ¥ç»“å°¾åçš„ç¬¬ä¸€ä¸ªbyteæ˜¯å¦`>=0 <=8` è‹¥å¦å°±ç½®ä¸º0
ç„¶åå–eax:èµ·å§‹ä½ç½®+24h å¤åˆ¶äº†0x100çš„æ•°æ®åˆ°`[ecx+ebx+0x54]`çš„å†…å­˜
åé¢å°±å¼€å§‹æœ‰è®¡ç®—hashå’Œdecryptçš„äº† ç»“åˆIDAå’ŒåŠ¨è°ƒ
![img](ä¸‡åé•œé€†å‘/images/image-3.png)
ç„¶åå°±æ˜¯å–0x20å­—èŠ‚è½¬unicodeåä¸ `8hr48uky,8ugi8ewra4g8d5vbf5hb5s6`å¯¹æ¯”
å…¶ä¸­å…³äºHashçš„è®¡ç®—ä»¥åŠdecryptçš„ç®—æ³•IDAä¸€ç›®äº†ç„¶ ä¸éœ€è¦è¿‡å¤šæ·±å…¥çš„åˆ†æ è§£å¯†æ—¶IDAå¼€ä¸€ä¸ªAutoCommentç…§ç€XMMæŒ‡ä»¤é›†å†™å³å¯
å¯èƒ½å…¶ä¸­ä¼šæ¶‰åŠåˆ°ä¸€äº›é—´æ¥è°ƒç”¨ä¹‹ç±»çš„ åŠ¨è°ƒæ‰¾ä¹Ÿæ¯”è¾ƒå¥½æ‰¾

è¿™é‡Œå‘ç°åªéœ€è¦è¿›å…¥decryptåŠ¨è°ƒä¸€äº›å€¼å³å¯
![img](ä¸‡åé•œé€†å‘/images/image-4.png)
è¿™é‡Œä¸€ä¸ªæ˜¯é•¿åº¦ å¦ä¸€ä¸ªå°±æ˜¯å…ˆå‰è®¡ç®—å¾—åˆ°çš„hashå€¼ `0658D1A0`
å…¶å®å’Œå…ˆå‰çš„hashæœ‰ä¸€ç‚¹ç‚¹å°åŒºåˆ«? åŠ¨è°ƒå¾—åˆ°çš„hashå‡½æ•°è¿”å›eaxæ˜¯ `D658D1A0`
è¿™æ ·åˆå§‹çš„ `*(_DWORD *)(a1 + 8)`å’Œ `*(_DWORD *)(a1 - 4)`å°±å¾—åˆ°äº†
è¿˜æœ‰ä¸€ä¸ª `*(__m64 **)(a1 - 8)` åŠ¨è°ƒå‘ç°æ˜¯ä¸€ä¸ªæŒ‡å‘å…ˆå‰è¯»å–440å­—èŠ‚æ•°æ®çš„æŒ‡é’ˆ ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„è§£å¯†æºæ•°æ®
ç„¶åå–äº†0x20æ¥è§£å¯†
è§£å‡ºæ¥çš„å°±æ˜¯ `8hrxxx` ç„¶åè½¬unicode éªŒç­¾

ç„¶åè¿›è¡Œäº†ä¸€å¤§å †èµ‹å€¼æ“ä½œ æ³¨æ„ç»†çœ‹
![img](ä¸‡åé•œé€†å‘/images/image-5.png)
ç»“åˆcdqæˆ‘ä»¬å¯ä»¥çŸ¥é“ `FilePack`é‡Œé¢çš„Entryåº”è¯¥æ˜¯QWORDç±»å‹ è€Œä¸”åªæœ‰ä¸‰ä¸ªæˆå‘˜
æ‰€ä»¥å¯ä»¥å†™å‡º`FilePack`ç»“æ„

```c++
struct FilePack{
    char sign[0x10];
    DWORD size;
    QWORD EntryPoint;
}
```

ç„¶ååˆå¼€å§‹è®¾ç½®æ–‡ä»¶æŒ‡é’ˆ
`è®¾ç½®æ–‡ä»¶æŒ‡é’ˆ  å¥æŸ„:35C åç§»é‡:024D072F  åŸºå‡†:0`
æŒ‡å‘çš„æ­£æ˜¯data0ä¸­çš„HashVerç»“æ„ä½“
ç„¶åè°ƒç”¨CopyFrom æ¥ç€åˆæ„é€ äº†ä¸€ä¸ªç±»
ç„¶åçœ‹æ—¥å¿—å‘ç° `è¯»å–æ–‡ä»¶:  å¥æŸ„:35C ç¼“å†²:296C5B0 å­—èŠ‚æ•°:28D`
æŸ¥çœ‹å¯¹åº”å†…å­˜
![img](ä¸‡åé•œé€†å‘/images/image-6.png)
æ‰€ä»¥å‰é¢ä»data0å¤åˆ¶HashVeråˆ°å†…å­˜ä¸­

ç°åœ¨æ¥å…³æ³¨ä¹‹å‰å–å‡ºçš„440å­—èŠ‚çš„æ•°æ® ä¸å¦¨ç§°ä½œ HashData å› ä¸ºHashè§£å¯†å‡ºä¸€ä¸ªç­¾å
ç„¶åæœ‰ä¸ªå¾ˆå…³é”®çš„æ˜¯ç­¾ååçš„ç¬¬ä¸€ä¸ªDWORD: 028D æ˜¯åé¢è®¡ç®—åœ°å€çš„offset

```c++
struct HashData{
    char sign[0x20]; //8hr...
    DWORD offset; // 028D
    char data[0x100]; //256å­—èŠ‚æ•°æ®
    DWORD unk; //å…ˆå‰æ£€éªŒdataåä¸€ä¸ªå­—èŠ‚ <0||>8å°±è®¾ç½®ä¸º0
    char Blank[0x2F8] //ç©ºå­—èŠ‚å ä½
    FilePack filepack; // FilePackç»“æ„ä½“
}
```

å…³æ³¨ä¸€ä¸‹æ€ä¹ˆé€šè¿‡ HashDataæ‰¾åˆ°HashVerçš„
![img](ä¸‡åé•œé€†å‘/images/image-7.png)
å¯ä»¥çœ‹åˆ°å…ˆæ˜¯å–å‡ºoffset 028D ç„¶åç”¨HashDataçš„åœ°å€å»ç´¢å¼•HashVer

æ¥ä¸‹æ¥å…³æ³¨å¯¹HashVerç»“æ„ä½“ä½œäº†ä»€ä¹ˆæ“ä½œ
![img](ä¸‡åé•œé€†å‘/images/image-8.png)
å‰é¢æ„é€ çš„ç±»çš„æŒ‡é’ˆæ˜¯æŒ‡å‘`HashVer`å¼€å¤´ æ‰€ä»¥å¯ä»¥ç¡®å®šä¸‹é¢æ˜¯å¯¹è¿™ä¸ªç»“æ„ä½“çš„å¤„ç†
`sub_4EB8C0`å‡½æ•°åœ¨IDAèƒ½å¤§è‡´çœ‹å‡ºåŠŸèƒ½
å…ˆéªŒç­¾ ç„¶åè§£å¯† å†Copyå›å†…å­˜
éªŒç­¾:
![img](ä¸‡åé•œé€†å‘/images/image-9.png)
å¯¹HashVerçš„æ•°æ®è¯»å–:
![img](ä¸‡åé•œé€†å‘/images/image-10.png)
ç„¶åç”¨CopyFromå¾€ç±»ä¸­å†™å…¥æ•°æ®
![img](ä¸‡åé•œé€†å‘/images/image-11.png)
å‘ç°è¿™ä¸ªå‡½æ•°è¿˜æ˜¯è§£å‡º `8hx...`çš„é‚£ä¸ª å°†å…¶é‡å‘½åä¸ºdecrypt
æ¥ä¸‹æ¥å‡ºç°äº†ç¬¬äºŒä¸ªè§£å¯†å‡½æ•°
![img](ä¸‡åé•œé€†å‘/images/image-12.png)

å†çœ‹0296C5B0å¤„çš„HashVerç»“æ„ä½“ ä¸€äº›å€¼çš„ä½œç”¨å°±æ¸…æ™°äº†
![img](ä¸‡åé•œé€†å‘/images/image-13.png)
å‰é¢è°ƒç”¨è¿‡GetSize è¿”å›çš„æ˜¯ 249h è¯´æ˜hashveråç¬¬å››ä¸ªDWORDå°±æ˜¯size
å‰é¢åˆåˆ†æè¿‡äº†ç¬¬äº”ä¸ªDWORDæ˜¯æ ‡å¿—ä½ å†³å®šæ˜¯å¦è°ƒç”¨decrypt2

æ‰€ä»¥è§£å¯†æµç¨‹å°±æ˜¯å…ˆå¯¹hashverçš„æ•°æ®ç”¨decryptè§£å¯† è‹¥æ ‡å¿—ä½ä¸º1 ç»§ç»­è¿›è¡Œdecrypt2è§£å¯†
decrypt2ç»“åˆIDA+x32dbgåŠ¨è°ƒæ•°æ®æ¥ç†è§£

ä¸€å †ReadFile ä½†æ˜¯å¹¶æ²¡æœ‰è°ƒç”¨API æ‰€ä»¥éœ€è¦æ‰‹åŠ¨è¿›å…¥æ‰¾åˆ°è¯»çš„é‚£ç‰‡å†…å­˜
![img](ä¸‡åé•œé€†å‘/images/image-14.png)
æ‰¾å‡ ä¸ªå¯„å­˜å™¨è¯•è¯•å°±æ‰¾åˆ°è¿™å—
æ¥ä¸‹æ¥çš„Readéƒ½æ˜¯åœ¨è¿™ç‰‡å†…å­˜ 028D8120
![img](ä¸‡åé•œé€†å‘/images/image-15.png)
ç¬¬ä¸€ä¸ªDWORDè‚¯å®šæ˜¯éªŒè¯ ç¬¬äºŒä¸ªå¤šåŠæ˜¯æ ‡å¿—ä½ ç¬¬ä¸‰ä¸ªæ˜¯size
è¿™é‡ŒReadFileè¯»å–çš„å€¼æ˜¯å­˜åœ¨ecxå¯„å­˜å™¨é‡Œçš„
åé¢å¯¹sizeè¿›è¡Œäº†ä¸€ä¸ªæ£€æŸ¥ ç»“åˆIDA: `v17<-[ebp-10h]` ä¹Ÿå¯ä»¥ç¡®å®šå‰é¢922hå°±æ˜¯size

åé¢æœ‰ä¸€äº›é—´æ¥å¯»å€æ“ä½œ ç»“åˆåŠ¨è°ƒæ¥çœ‹
ä»004E5722å¼€å§‹
![img](ä¸‡åé•œé€†å‘/images/image-16.png)
è¿™é‡ŒåŠ¨è°ƒä¸€ä¸‹ä¼šå‘ç°æœ‰size æœ‰å¾…è§£å¯†æ•°æ®çš„èµ·å§‹åœ°å€ åˆç»“åˆIDAçŸ¥é“è¿™å°±æ˜¯ endæŒ‡é’ˆ
`idr617538_Move(v10, v11, 256);` è¿™å¥å°±æ˜¯æŠŠå‰é¢å»ºçš„[0~255]çš„è¡¨å¤åˆ¶ä¸€ä»½ åŸè¡¨æ˜¯v10
æ¥ä¸‹æ¥IDAåç¼–è¯‘éƒ½æ¯”è¾ƒæ¸…æ™°
æ³¨æ„åˆ°ç¬¬85è¡Œ`if ( (v12 & 1) == 1 ) ` è¿™é‡Œå¾€å‰ç¿»å°±çŸ¥é“æ˜¯è¯»å–çš„ç¬¬äºŒä¸ªDWORD ä¹Ÿå°±æ˜¯æˆ‘ä»¬çŒœæµ‹çš„æ ‡å¿—ä½1
å…¶å®è¿™é‡Œå°±æ˜¯ä¸€ä¸ªæ•°æ®ç±»å‹æ ¼å¼çš„check
![img](ä¸‡åé•œé€†å‘/images/image-17.png)
æ ¹æ®ä¸åŒæ•°æ®æ ¼å¼æ¥ç§»æŒ‡é’ˆ
æ ‡å¿—ä½ä¸º1ä»£è¡¨æ˜¯WORDç±»å‹

æœ€åæ³¨æ„ä¸‹è™½ç„¶çœ‹ä¼¼åªæœ‰ä¸€æ¬¡ifä½†æ˜¯åé¢æœ‰ä¸ª `goto label36` æ‰€ä»¥æ˜¯ä¸ªå¾ªç¯
è¿™ä¸ªå¾ªç¯ä¸­å¥—çš„ä¸€ä¸ª æ ˆ+æ‰¾indexçš„è§£å¯†
![img](ä¸‡åé•œé€†å‘/images/image-18.png)
å¯ä»¥é€šè¿‡ `v15 <- v15 = (_BYTE *)*((_DWORD *)v16 + 1);` çŸ¥é“v15å°±æ˜¯æŒ‡å‘ä»¥v16èµ·å§‹çš„ç©ºé—´
æœ€åè¿”å›è§£å¯†åçš„ç±»æŒ‡é’ˆ

ä¸ºäº†ç»Ÿä¸€ å¯¹è¿™éƒ¨åˆ†è§£å¯†çš„æ•°æ®ç»“æ„è£…ä¸€ä¸ªç»“æ„ä½“ å‘½åä¸º Decrypt2DataHead(è·Ÿæ•™ç¨‹ä¸€æ ·)
å› ä¸ºè¿™æ˜¯decrypt2ä¹‹å‰çš„å¤´éƒ¨ç»“æ„ å¾ˆå®¹æ˜“å†™å‡ºæ¥
Decrypt2DataHead:

```c++
struct Decrypt2DataHead{
    DWORD sign; //FF435031
    DWORD isWord; // 1:unsigned __int16
    DWORD size; // 922h
}
```

æ‰¾åˆ°è§£å¯†æ•°æ®çš„å†…å­˜ 028DA150 ç„¶åè·‘å®Œdecrypt2
![img](ä¸‡åé•œé€†å‘/images/image-19.png)
![img](ä¸‡åé•œé€†å‘/images/image-20.png)

è§£å‡ºæ¥çš„éƒ½æ˜¯æ–‡ä»¶å æ‰€ä»¥HashVerçš„æ•°æ®å­˜çš„åº”è¯¥æ˜¯è¿™ä¸ªpacké‡Œæ‰“åŒ…çš„æ–‡ä»¶å
å¯ä»¥æ•°ä¸‹æœ‰å¤šå°‘ä¸ªæ–‡ä»¶ 18ä¸ª 12h åˆšå¥½å¯¹åº”HashVerçš„ç¬¬äºŒä¸ªDword åŒæ—¶ä¹Ÿè·ŸFilePacké‡Œçš„sizeå¯¹åº”ä¸Šäº†
HashVerçš„ç»“æ„:

```c++
struct HashVer{
    char sign[0x10]; // HashVer1.4
    DWORD table_size;  // 100h å¯èƒ½æ˜¯è¡¨çš„å¤§å°???
    DWORD file_cnt; // 12h
    DWORD unk; // 48h
    DWORD dataSize; // 249h
    DWORD signal; // æ ‡å¿—ä½ 1 åˆ™decrypt2
    ...
    char data[0x249]; // åŠ å¯†çš„æ•°æ®
}
```

è·³å‡ºå‡½æ•° å›åˆ° 4EDA1B
ç°åœ¨æˆ‘ä»¬è¿˜åœ¨æ–‡ä»¶è¯»å–åˆå§‹åŒ–å‡½æ•°ä¸­ åˆšåˆšç»“æŸäº†éªŒç­¾+è§£å¯†æ•°æ®ç­‰æ“ä½œ
ç„¶åæ–°è®¾ç½®äº†æ–‡ä»¶æŒ‡é’ˆ `è®¾ç½®æ–‡ä»¶æŒ‡é’ˆ  å¥æŸ„:350 åç§»é‡:024D0135  åŸºå‡†:0`
![img](ä¸‡åé•œé€†å‘/images/image-21.png)
å‘ç°å°±æ˜¯ `FilePack`çš„å‡ ä¸ªæ•°æ® sizeå’ŒEnrtyPoint
ç„¶åè¿›è¡Œäº†ä¸€ä¸ª 12æ¬¡(sizeæ¬¡)çš„å¾ªç¯ é‚£ä¹ˆåº”è¯¥å°±æ˜¯åˆ†åˆ«è§£å¯†æ¯ä¸ªæ–‡ä»¶çš„æ•°æ®äº†
IDAå¯ä»¥å¾ˆç›´è§‚çš„çœ‹å‡ºæ¥:
![img](ä¸‡åé•œé€†å‘/images/image-22.png)
`sub_4E4C18`å°±æ˜¯å…³é”®çš„è§£å¯†å‡½æ•°
å…ˆIDAçœ‹ä¸ªå¤§æ¦‚ç»“æ„
![img](ä¸‡åé•œé€†å‘/images/image-23.png)
åŠ¨è°ƒçœ‹ä¸€çœ‹é—´æ¥è°ƒç”¨å³å¯
å¯ä»¥å‘ç°è¿™éƒ¨åˆ†æŒ‡å‘äº†HashData
![img](ä¸‡åé•œé€†å‘/images/image-24.png)
æ³¨æ„åˆ°ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°` *(_DWORD *)(*(_DWORD *)v1 + 80)` ä¹Ÿå°±æ˜¯edx æŒ‡å‘çš„æ˜¯ä¹‹å‰ç®—å‡ºçš„Hashå€¼ `0658D1A0`
ç„¶ååˆReadFile `è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2`
è¯»äº† `00 24`
hashdataå‰é¢æœ‰ä¸€å † å‘ç°æ˜¯ä¸€äº›ç‰ˆæƒå£°æ˜çš„æ—¥æ–‡
![img](ä¸‡åé•œé€†å‘/images/image-25.png)
ç„¶ååˆæœ‰ReadFile `è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:2981650 å­—èŠ‚æ•°:48`
è¯»çš„å­—èŠ‚æ•°æ˜¯2*v4 v4çš„åˆå§‹å€¼æ˜¯24h
è¿™é‡Œçš„48å’ŒHashVerçš„é‚£ä¸ªunkçš„å€¼å¯èƒ½æœ‰å…³è”
ç„¶åå°±æ˜¯è§£å¯†äº† IDAå¾ˆæ˜æ™°
è¿™é‡Œv15å–çš„åº”è¯¥æ˜¯è§£å¯†æ•°æ®å­˜æ”¾å†…å­˜çš„æŒ‡é’ˆ(ä¿®æ”¹äº†æ•°æ®æ ¼å¼ unicodeè½¬äº†ä¸€ä¸‹ WORDç±»å‹)
do-whileå¾ªç¯äº†24hæ¬¡
![img](ä¸‡åé•œé€†å‘/images/image-26.png)
è§£å¯†å®Œåå›åˆ°ä¹‹å‰çš„å¾ªç¯ç»§ç»­ä¸‹ä¸ªæ–‡ä»¶çš„è§£å¯†
æ—¥å¿—æ‰“å°å¦‚ä¸‹:

```
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
æ–­ç‚¹å·²è®¾ç½®åœ¨ 004E4CB8 ï¼
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004E4CB8 (004E4CB8)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:2981650 å­—èŠ‚æ•°:48
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D6118 å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:29AFDC8 å­—èŠ‚æ•°:12
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D6134 å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:29CB858 å­—èŠ‚æ•°:18
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D6150 å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:299F590 å­—èŠ‚æ•°:2C
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D616C å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:299F590 å­—èŠ‚æ•°:26
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D6188 å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:299F590 å­—èŠ‚æ•°:28
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D61A4 å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:29B4D58 å­—èŠ‚æ•°:30
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D61C0 å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:29B4D58 å­—èŠ‚æ•°:30
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D61DC å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:29BBE28 å­—èŠ‚æ•°:36
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D61F8 å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:29BBE28 å­—èŠ‚æ•°:36
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D6214 å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:29B4D58 å­—èŠ‚æ•°:34
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D6230 å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:29B4D58 å­—èŠ‚æ•°:34
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D624C å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:29BBF48 å­—èŠ‚æ•°:38
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D6268 å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:297A038 å­—èŠ‚æ•°:52
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D6284 å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28CBDD0 å­—èŠ‚æ•°:56
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D62A0 å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:297A038 å­—èŠ‚æ•°:54
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D62BC å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28CBEA0 å­—èŠ‚æ•°:56
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D62D8 å­—èŠ‚æ•°:1C
INT3 æ–­ç‚¹äº æœˆã«å¯„ã‚Šãã†ä¹™å¥³ã®ä½œæ³•2.2.004EDA9A (004EDA9A)!
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:19F642 å­—èŠ‚æ•°:2
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:29B4D58 å­—èŠ‚æ•°:34
è¯»å–æ–‡ä»¶:  å¥æŸ„:364 ç¼“å†²:28D62F4 å­—èŠ‚æ•°:1C
```

ç„¶åæ¥åˆ†æè¿™äº›è¯»å–çš„ç©¶ç«Ÿæ˜¯äº›ä»€ä¹ˆæ•°æ®
çœ‹éƒ½æ˜¯å›ºå®šé•¿åº¦1Cçš„æ•°æ® å¤šåˆ†æå‡ ç»„
`00 00 00 00 00 00 00 00 23 10 00 00 23 10 00 00 00 00 00 00 01 00 00 00 12 40 63 EB`
`23 10 00 00 00 00 00 00 57 02 00 00 F6 06 00 00 01 00 00 00 01 00 00 00 23 F2 E4 E4`
`7A 12 00 00 00 00 00 00 64 03 00 00 64 12 00 00 01 00 00 00 01 00 00 00 BC 0C 7A ED`
`DE 15 00 00 00 00 00 00 1C 12 00 00 1C 12 00 00 00 00 00 00 01 00 00 00 0C E4 5E FF`
...
`0C 4F 00 00 00 00 00 00 A5 0A 00 00 A5 0A 00 00 00 00 00 00 01 00 00 00 EA C6 DC F9`

ç”±æ—¥å¿—å¯ä»¥çœ‹å‡º1Cè¿™ç»„åœ°å€æ˜¯è¿ç»­çš„ å¾ˆåƒä¸€ä¸ªç»“æ„ä½“æ•°ç»„
ç”±ç¬¬ä¸€äºŒç»„ => 00 00 00 00 + 23 10 00 00 = 23 10 00 00
å¤§è‡´èƒ½ç¡®å®šå‰ä¸¤ä¸ªDWORDç»„æˆä¸€ä¸ªQWORD(ç»“åˆå‰é¢çš„ç»éªŒ)ä»£è¡¨åœ°å€ ç„¶åç¬¬ä¸‰ä¸ªDWORDä»£è¡¨size(ç›¸é‚»åœ°å€çš„é—´éš”)
ç„¶åå‘ç°ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ç‚¹ è§‚å¯Ÿç¬¬å››ä¸ªå’Œç¬¬äº”ä¸ªDWORD
ä»ç¬¬äº”ä¸ªDWORDå…¥æ‰‹ å½“å…¶ä¸º0çš„æ—¶å€™ å‘ç°ç¬¬ä¸‰ä¸ªDWORDçš„sizeå’Œç¬¬å››ä¸ªDWORDçš„å€¼ä¸€æ ·
è€Œä¸º1çš„æ—¶å€™ ç¬¬å››ä¸ªæ¯”ç¬¬ä¸‰ä¸ªå¤§
ç”±äºè¿™æ˜¯åœ¨FilePackçš„æ–‡ä»¶è¯»å–åˆå§‹åŒ–ä¸­ ä¸”æˆ‘ä»¬ä»¥åŠè§£å¯†äº†æ–‡ä»¶å é‚£ä¹ˆç°åœ¨è§£çš„å°±æ˜¯æ–‡ä»¶æœ¬ä½“äº†
å¯ä»¥æ¨æ–­ç¬¬äº”ä¸ªDWORDæ˜¯æ ‡å¿—ä½ ä»£è¡¨å¤§å°æ˜¯å¦æ”¹å˜ é‚£ä¹ˆç¬¬å››ä¸ªDWORDå°±åº”è¯¥æ˜¯è§£å¯†åçš„sizeäº†  è‡³äºæœ€åä¸€ä¸ªDWORDå®Œå…¨çœ‹ä¸å‡ºæ¥ å¯èƒ½æ˜¯CRCæ ¡éªŒä¹‹ç±»çš„
ç”±äºè¿™ä¸ªç»“æ„ä½“çš„åŠŸèƒ½æ˜¯ ç´¢å¼•åœ°å€+æä¾›è§£å¯†æ‰€éœ€çš„æ ‡å¿—å‚æ•° å°†å…¶å‘½åä¸ºFileEntry(è¿˜æ˜¯å–ä¸€æ ·çš„)
ç»“æ„å¦‚ä¸‹:

```c++
struct FileEntry{
    QWORD offset; // DWORD2:DWORD1
    DWORD size;
    DWORD decrypted_size; // è§£å¯†åçš„size
    DWORD isCompressed; // 0/1 æ ‡å¿—ä½
    DWORD unk1; // all_the_same : 1
    DWORD unk2; // maybe hash/CRC
}
```

### æ–‡ä»¶è§£å¯†

ç„¶åè¦ç­‰æ‰€æœ‰æ–‡ä»¶çš„æ–‡ä»¶åéƒ½è§£å®Œè¿‡åæ‰è¿›å…¥æ–‡ä»¶è§£å¯†
å‰é¢çš„æµç¨‹å¤§è‡´æ˜¯æŠŠæ¯ä¸ªdatax.packçš„æ–‡ä»¶åéƒ½è§£å¯†äº† ç„¶åéƒ½è¯»å–äº†FileEntry
ç»“æŸåæ—¥å¿—å‘ç°æœ‰ä¸ª `è¯»å–æ–‡ä»¶:  å¥æŸ„:360 ç¼“å†²:3CED440 å­—èŠ‚æ•°:1023`
å…³é”®çš„è§£å¯†å‡½æ•°åœ¨sub_4ED454 ä½†æ‰¾ä¸åˆ°æ˜¯æ€ä¹ˆè¿›åˆ°è¿™ä¸ªå‡½æ•°çš„...
IDAçœ‹å¤§è‡´ç»“æ„:
![img](ä¸‡åé•œé€†å‘/images/image-27.png)
æ ¹æ®ä¼ å…¥çš„å‚æ•°æ¥é€‰æ‹©ä¸åŒåˆ†æ”¯
![img](ä¸‡åé•œé€†å‘/images/image-28.png)
è¿›å…¥decrypt3ååˆæœ‰ä¸ªåˆ†æ”¯
![img](ä¸‡åé•œé€†å‘/images/image-29.png)
ä½†å…¶å®IDAçœ‹ä¸€æ¨¡ä¸€æ ·... åªæ˜¯å†™æ³•æœ‰ä¸€ç‚¹å·®å¼‚ å®ç°åŠŸèƒ½å®Œå…¨ç›¸åŒ

è¿‘æœˆ2æ‰€æœ‰éƒ½æ˜¯decrypt3 ä»å‰é¢åˆ†æçš„`FileEntry`ç»“æ„ä½“å¯çŸ¥
IDAçœ‹
![img](ä¸‡åé•œé€†å‘/images/image-30.png)
ç”±å‰é¢çš„ç»éªŒçŸ¥é“`sub_4ECE7C(a1);`å°±æ˜¯ç®—å‡ºä¸€ä¸ªhashä¾›åé¢ä½œä¸ºkeyè§£å¯†
è¿›å…¥hashå‡½æ•°
![img](ä¸‡åé•œé€†å‘/images/image-31.png)

å…ˆæ˜¯ç”¨ "pack_keyfile_kfueheish15538fa9or.key"å¯¹ä¸¤ä¸ªkeyåˆåšäº†åŠ å¯†
ç„¶åè¿›å…¥sub_4ECE40ç®—HASH
è¿™é‡Œçš„ä¼ å‚è¦ä»”ç»†åŠ¨è°ƒ
![img](ä¸‡åé•œé€†å‘/images/image-32.png)
è€Œå¦ä¸€ä¸ªè°ƒä¸€è°ƒå‘ç°æ˜¯å‰é¢ä¼ å…¥çš„1023 ä¹Ÿå°±æ˜¯è¯»å–æ–‡ä»¶çš„size
![img](ä¸‡åé•œé€†å‘/images/image-33.png)
![img](ä¸‡åé•œé€†å‘/images/image-34.png)


XMMæŒ‡ä»¤é›†å¼€ä¸ªè‡ªåŠ¨æ³¨é‡Šå°±éƒ½èƒ½å¼„æ‡‚ `_m_pslldi`æ˜¯DWORDé€»è¾‘å·¦ç§»
ç„¶ååŠ¨è°ƒçœ‹çœ‹å“ªä¸ªå€¼æŒ‡å‘hash[]
![img](ä¸‡åé•œé€†å‘/images/image-35.png)
![img](ä¸‡åé•œé€†å‘/images/image-36.png)

åˆ°æ­¤ è¿‘æœˆ2çš„æ–‡ä»¶è§£å¯†å·²ç»å‘Šä¸€æ®µè½äº†
è¿‘æœˆ2éƒ½ç”¨çš„decrypt3 è€Œ ä¸‡åé•œç”¨çš„éƒ½æ˜¯decrypt4

æ€»æµç¨‹:
![img](<ä¸‡åé•œé€†å‘/images/flow.png>)


# ä¸‡åé•œ5
ç»è¿‡å‰é¢è¿‘æœˆ2çš„é€†å‘ å¯¹qlieå¼•æ“æœ‰äº†ä¸€å®šçš„äº†è§£
ä¸‡åé•œ5å’Œè¿‘æœˆ2æœ€å¤§çš„ä¸åŒå°±åœ¨äºå‰è€…é‡‡ç”¨çš„æ˜¯decrypt4

wtmè°¢è°¢ä½ ... ä¼Ÿå¤§çš„æ±‰åŒ–ç»„æ±‰åŒ–å®ŒåŠ äº†ä¸ªå£³...
![img](ä¸‡åé•œé€†å‘/images/image-37.png)

å…ˆçœ‹çœ‹ä¸‡åé•œ4 æ„Ÿè§‰é€»è¾‘åº”è¯¥å·®ä¸äº†å¤ªå¤š
ç¬¬ä¸€ä¸ªéš¾ç‚¹ å¦‚ä½•å®šä½åˆ°decrypt4çš„åœ°æ–¹?
å½“ç„¶å¯ä»¥å†è·Ÿç€è¿‘æœˆ2çš„æ­¥éª¤è°ƒè¯•ä¸€é
ä½†æœ‰ä¸ªæ›´å¥½ç”¨çš„æ–¹æ³•:
æˆ‘ä»¬çŸ¥é“è¿™ä¸¤æ¬¾æ¸¸æˆçš„å¼•æ“æ˜¯ä¸€æ ·çš„ æ‰€ä»¥åŸºæœ¬ç‰¹å¾è‚¯å®šæ˜¯ç›¸åŒçš„
æˆ‘ä»¬å¤åˆ¶è¿‘æœˆ2çš„decrypt3é™„è¿‘çš„å­—èŠ‚ç 
![img](ä¸‡åé•œé€†å‘/images/image-38.png)
ç„¶ååœ¨x32dbgçš„å†…å­˜å¸ƒå±€é‡Œæœç´¢åŒ¹é…ç‰¹å¾
![img](ä¸‡åé•œé€†å‘/images/image-39.png)
å—–çš„ä¸€ä¸‹ å°±æœåˆ°äº†~
æˆåŠŸå®šä½
![img](ä¸‡åé•œé€†å‘/images/image-40.png)

å¾ˆç¦»è°±çš„æ˜¯ä¸ºä»€ä¹ˆä¸‡åé•œ4å¤§éƒ¨åˆ†éƒ½æ˜¯decrypt3å•Š...
ç»ˆäºæ–­åˆ°decrypt4è¿‡åå°±å¯ä»¥å¼€å§‹é€†äº†~
å°†è¿‘æœˆ2çš„decrypt3å’Œé•œçš„decrypt4å¯¹æ¯”ç€çœ‹å¾ˆå®¹æ˜“çœ‹å‡ºåŒºåˆ«

## decrypt4
å¼€å§‹åˆ†æ
è¿›å…¥åè·Ÿdecrypt3ä¸€æ · ä¹Ÿæœ‰ä¸¤ä¸ªåˆ†æ”¯ ä½†æ˜¯éƒ½æ˜¯å¤§åŒå°å¼‚ åŠŸèƒ½å®Œå…¨ä¸€æ ·
è€Œä¸”å¯¹æ¯”è¿‘æœˆ2å’Œé•œ4å‘ç°decrypt4å‡½æ•°ä¹Ÿä¸€æ¨¡ä¸€æ ·
æ‰€æœ‰å…³é”®å‚æ•°ç”šè‡³è¿å˜é‡å‘½åéƒ½ä¸€æ · æ‰€ä»¥å¯ä»¥æ”¾å¿ƒé€†é•œ4çš„decrypt4

IDAå¤§è‡´å¯¹æ¯”ä¸€ä¸‹dec3å’Œdec4
![img](ä¸‡åé•œé€†å‘/images/image-41.png)
![img](ä¸‡åé•œé€†å‘/images/image-42.png)

é¦–å…ˆæ˜¯hashå‡½æ•°å®ç°ä¸åŒ ç„¶åå°±æ˜¯dec4å¤šäº†ä¸€ä¸ªhashè¡¨/keyè¡¨ ç”¨çš„åŒè¡¨åŠ å¯†è€Œé3çš„å•è¡¨åŠ å¯†

ä½†hashå‡½æ•°ä¹Ÿåªæ˜¯æ”¹äº†äº›åŠ å¯†å¸¸é‡è€Œå·² å…·ä½“ç®—æ³•éƒ½æ²¡å˜

æ¥ä¸‹æ¥å…³æ³¨é‚£ä¸ªå¤šå‡ºæ¥çš„è¡¨
![img](ä¸‡åé•œé€†å‘/images/image-43.png)
ç¡®å®æœ‰å¦ä¸€ä¸ªtableåœ¨ æ€»é•¿åº¦ä¸º0x400 bytes
å¾ˆå·§çš„æ˜¯æ•™ç¨‹ç”¨é•œ5 ä¸åŒçš„æ–‡ä»¶è°ƒç”¨decrypt4æ—¶çš„tableé•¿åº¦æ˜¯ä¸€æ ·çš„ å†…å®¹ä¸ä¸€æ ·
é‚£å°±å¾ˆè‡ªç„¶æƒ³çŸ¥é“è¿™ä¸ªtableæˆ–è€…keyæ•°ç»„åœ¨å“ªé‡Œè¢«æ€ä¹ˆç®—å‡ºæ¥çš„?

### å›æº¯æ‰¾`key[]`
æ•™ç¨‹æ•™äº†ä¸€ä¸ªå¾ˆæ£’çš„æ–¹æ³• ç”¨å¼ºå¤§çš„CheatEngineæ¥æœç´¢è¿™ä¸ªkeyæ•°ç»„
æœç´¢é€‰é¡¹è°ƒæˆæœç´¢`å­—èŠ‚æ•°ç»„`
å°±æœç´¢å¼€å¤´çš„å‡ ä¸ªDWORD
`48 BA EC 20 08 60 BB 96 6E 12 88 8E D7 5B 2F 35 02 5F DA D7 11 9A 9F B7 03 6C 7D CA E3 FE 3F 07`
å‘ç°å·²ç»å¯æ•°äº†
æ‰«é•œ4:
![img](ä¸‡åé•œé€†å‘/images/image-45.png)
æ¥ä¸‹æ¥å°±æ˜¯é€æ­¥å¾€å‰å›æº¯äº† å»æ‰¾åœ¨å“ªä¸ªè°ƒç”¨ç‚¹çš„æ—¶å€™åˆšå¥½ç®—å‡ºäº†key
è¿˜æƒ³ç€çœ‹èƒ½ä¸èƒ½é€šè¿‡IDAçš„ç«‹å³æ•°æœç´¢ç¼©å°ä¸€ä¸‹èŒƒå›´ å‘ç°0x400å‡ºç°çš„å¤ªå¤š è¿˜æ˜¯è€è€å®å®çœ‹äº¤å‰å¼•ç”¨å§...

å¾€ä¸Šå›æº¯åˆ°è¿›å…¥è°ƒç”¨dec3,4çš„å‡½æ•° æ–­åœ¨dec3å‘ç°å·²ç»ç®—å‡ºkeyäº†...
è·Ÿä¹‹å‰çŒœæµ‹æœ‰è¯¯ è¯´æ˜è¿™ä¸ªkeyä¹Ÿè®¸æ˜¯å›ºå®šçš„?
ç»§ç»­å¾€ä¸Šå›æº¯
å‘ç°æœ‰ä¸¤ä¸ªå¯èƒ½ ä¸‹æ–­ç‚¹æ ‡è®°ä¸€ä¸‹ å‘ç°åœ¨ç¬¬äºŒä¸ªè¿›å…¥çš„
![img](ä¸‡åé•œé€†å‘/images/image-46.png)

ä»`sub_4E966C`å†å¾€ä¸Šå›æº¯
ä¸‹æ–­ç‚¹åŠ¨è°ƒ<- `sub_4E9800`
<-`sub_4EA4B4` è¿˜æœ‰key[]...
<-`sub4EC5AC`
å†å›æº¯å°±æœ‰å¾ˆå¤šåˆ†æ”¯äº†...
ç›´æ¥ä¸€é”®åœ¨æ‰€æœ‰åˆ†æ”¯è®¾æ–­ç‚¹ å‘ç°æ–­åœ¨ä¸€ä¸ªæ¯”è¾ƒå¥‡æ€ªçš„åœ°å€
![img](ä¸‡åé•œé€†å‘/images/image-47.png)
åœ°å€æ˜¯6å¼€å¤´ ä¸æ˜¯ç”¨æˆ·åŒºçš„4ä¹Ÿä¸æ˜¯ç³»ç»ŸåŒºçš„7 è€Œæ˜¯å¼•æ“çš„ä»£ç ?
æ¥åˆ°äº†`sub_6DD224`å‡½æ•°
<-`sub_6DD9B8`
å‘ç°åœ¨è¿™ä¸ªå¼€å¤´çš„æ—¶å€™å°±æ²¡æœ‰keyäº†!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
![img](ä¸‡åé•œé€†å‘/images/image-48.png)
æ²¡å¤šå°‘äº† æ…¢æ…¢æ’é™¤
æŒ¨ä¸ªifä¸‹æ–­ç‚¹CEæ¥æ‰¾
å¾—åˆ°ç»“è®º:
![img](ä¸‡åé•œé€†å‘/images/image-49.png)
å°±æ˜¯åœ¨sub_4EC10Cé‡Œé¢çš„do-whileæ¥ç®—çš„key
ä½†4è¿™é‡Œé¢çœ‹èµ·æ¥å®Œå…¨ä¸åƒæ˜¯åœ¨è®¡ç®—keyçš„å•Š...
é‡‡å–ä¸€æ­¥ä¸€æ®µç„¶åCEæŸ¥çš„æ–¹æ³• å®šä½åˆ°è¿™é‡Œ
![img](ä¸‡åé•œé€†å‘/images/image-50.png)
å‘ç°è²Œä¼¼å¼•ç”¨äº†data0.hashè¿™ç§
![img](ä¸‡åé•œé€†å‘/images/image-51.png)
è¿™å°±å°´å°¬äº†...
åœ¨æƒ³æ˜¯ä¸æ˜¯4å’Œ5çš„åŒºåˆ«???
...æœäº†...
ä¹Ÿå°±æ˜¯5ä¹‹å‰çš„é•œæ˜¯ç”¨å‰é¢æ–‡ä»¶è§£å¯†å¾—åˆ°çš„datax.hashæ¥è®¡ç®—???æˆ–æ˜¯ç›´æ¥copyè¿‡æ¥???
åç»­ä»£ç ç¼–å†™åè¿è¡Œä¹Ÿå‘ç°ç¡®å®æœ‰è¾ƒå¤§åŒºåˆ«
å…ˆè¿˜æ˜¯æŒ‰ç…§é•œ5çš„ä»£ç æ¥å†™
å½“ç„¶é€†å‘çš„åŸºæœ¬æµç¨‹å·²ç»å…¨éƒ¨å®æ“è¿‡äº† ç­‰æ‰¾åˆ°é•œ5çš„æ— å£³ç‰ˆæœ¬å†æ‰¾ä¸€ékeyçš„ç”Ÿæˆå‡½æ•°

### é•œ5å›æº¯æ‰¾ `key[]`
ç»ˆäºæ‰¾åˆ°æ— å£³çš„ç‰ˆæœ¬äº†~
å†å›æº¯æ‰¾ä¸€ékey
æœ‰äº†é•œ4æ‰¾dec4å’Œkeyçš„ç»éªŒ å¾ˆå¿«èƒ½å®šä½åˆ°è¿™é‡Œ
![img](ä¸‡åé•œé€†å‘/images/image-52.png)
ç„¶åå°±æ…¢æ…¢åœ°CEå›æº¯å§
è·Ÿåˆ°è¿™é‡Œå‘ç°å·²ç»æœ‰PACK/keyå­—æ ·äº†
![img](ä¸‡åé•œé€†å‘/images/image-53.png)
å†å¾€å‰å¯ä»¥è¿½åˆ°`710E8D` è¿™æ˜¯å¼•æ“ä»£ç çš„åŒºåŸŸ
æœ€åå®šä½åˆ°è¿™ä¸ªåˆ†ç•Œç‚¹
![img](ä¸‡åé•œé€†å‘/images/image-54.png)
![img](ä¸‡åé•œé€†å‘/images/image-55.png)
æœ€ç»ˆç¡®å®š![img](ä¸‡åé•œé€†å‘/images/image-56.png)
ç¡®å®šåˆ°æŸä¸ªå…·ä½“çš„callå é‡Œé¢è¿˜æœ‰å¾ˆå¤šçœ‹ä¼¼æ²¡æœ‰è®¡ç®—keyçš„ é‡‡å–é€ä¸ªä¸‹æ–­ ç¼©å°èŒƒå›´
(å‘ç°è·Ÿé•œ4è²Œä¼¼æ˜¯ä¸€æ ·çš„... çœ‹æ¥è¿˜æ˜¯æ²¡è·Ÿè¸ªåˆ°æ¯ä¸€ä¸ªcall...)
è¿›ä¸€æ­¥ç¼©å°åˆ°è¿™é‡Œ ![img](ä¸‡åé•œé€†å‘/images/image-57.png)
Finally ç»ˆäºå®šä½åˆ°äº†![img](ä¸‡åé•œé€†å‘/images/image-58.png)
IDAçœ‹
![img](ä¸‡åé•œé€†å‘/images/image-59.png)
åŠ¨è°ƒè·Ÿè¸ªçœ‹é—´æ¥è°ƒç”¨
![img](ä¸‡åé•œé€†å‘/images/image-60.png)
tableå°±å­˜åœ¨`[ebp]`ä¸­
![img](ä¸‡åé•œé€†å‘/images/image-61.png)

ğŸ‰ğŸ‰ğŸ‰

# è§£å¯†ä»£ç 
åˆ°äº†æœ€åçš„ç¯èŠ‚äº† æ ¹æ®å‰é¢å¾—åˆ°çš„æ‰€æœ‰ä¿¡æ¯æ¥ç¼–å†™é•œ5çš„è§£åŒ…ç¨‹åº

è‡ªå·±å°è¯•å†™åˆ°decrypt3_hash åé¢æ˜¯åœ¨å†™ä¸åŠ¨äº†... ä¹Ÿä¸æ˜¯å¾ˆæƒ³å†å¼€x32dbgå»æ‰¾å¯¹åº”offsetäº† å†åŠ ä¸Šæ²¡æœ‰é•œ5ä¹Ÿä¸å¥½æ‰¾decrypt4_hash
åœ¨ä½¬çš„æºä»£ç ä¸Šåšäº†äº›ä¿®æ”¹ åŠ äº†ä¸€äº›è‡ªå·±çš„ç†è§£ å¸Œæœ›æœ‰æœä¸€æ—¥èƒ½å¤Ÿç‹¬ç«‹å†™å‡ºè¿™æ ·çš„ä»£ç  æŠŠä¸‡åé•œ4ç±»ä¼¼çš„ç‹¬ç«‹è§£åŒ…å§~
```c++
#include<bits/stdc++.h>
#include<Windows.h>
#include<mmintrin.h>
#define QWORD unsigned __int64
#define __PAIR64__(high, low)   (((QWORD) (high) << 32) | (DWORD)(low))
using namespace std;
struct FilePackVer
{
    char sign[0x10];
    DWORD filecount;
    int entry_low;
    int entry_high;
};
struct HashData
{
    char sign[0x20];
    DWORD HashVerSize;
    char data[0x100];
    DWORD Unkown;
    char Blank[0x2F8];
    FilePackVer fpacker;
};
struct Dencrypt2DataHead
{
    DWORD sign;
    DWORD isWordType;
    DWORD size;
};
struct Dencrypt2DataOutput
{
    BYTE* data;
    DWORD len;
};
struct FileEntry
{
    DWORD offset_low;
    DWORD offset_hight;
    DWORD size;
    DWORD dencrypted_size;
    DWORD isCompressed;
    DWORD EncryptType;
    DWORD hash;
};
DWORD Tohash(void* data, int len)
{
    if (len < 8)return 0;
    //å‡†å¤‡å·¥ä½œ
    __m64 mm0 = _mm_cvtsi32_si64(0);
    __m64 mm1;
    __m64 mm2 = _mm_cvtsi32_si64(0);
    DWORD key = 0xA35793A7;
    __m64 mm3 = _mm_cvtsi32_si64(key);
     mm3 = _m_punpckldq(mm3, mm3);
     __m64* pdata=(__m64*)data;
    for (size_t i = 0; i < (len >> 3); i++)
    {
        mm1 = *pdata;
        pdata++;
        mm2 = _m_paddw(mm2, mm3);
        mm1 = _m_pxor(mm1, mm2);
        mm0 = _m_paddw(mm0, mm1);
        mm1 = mm0;
        mm0 = _m_pslldi(mm0, 3);
        mm1 = _m_psrldi(mm1, 0x1D);
        mm0 = _m_por(mm1, mm0);
    }
    mm1 = _m_psrlqi(mm0, 32);
    DWORD result = _mm_cvtsi64_si32(_m_pmaddwd(mm0, mm1));
    _m_empty();
    return result;
}
void dencrypt(void* data,unsigned int len, DWORD hash)
{
    if (len >> 3 == 0)
        return;
    DWORD key1 = 0xA73C5F9D;
    DWORD key2 = 0xCE24F523;
    DWORD key3 = (len + hash)^ 0xFEC9753E;
    __m64 mm7 = _mm_cvtsi32_si64(key1);
    mm7 = _m_punpckldq(mm7, mm7);
    __m64 mm6 = _mm_cvtsi32_si64(key2);
    mm6 = _m_punpckldq(mm6, mm6);
    __m64 mm5 = _mm_cvtsi32_si64(key3);
    mm5 = _m_punpckldq(mm5, mm5);
    __m64* datapos = (__m64*)data;
    __m64 mm0;
    for (size_t i = 0; i < len >> 3; i++)
    {
        mm7 = _m_paddd(mm7, mm6);
        mm7 = _m_pxor(mm7, mm5);
        mm0 = *datapos;
        mm0 = _m_pxor(mm0, mm7);
        mm5 = mm0;
        *datapos = mm0;
        datapos++;
    }
    _m_empty();
    return;
}
Dencrypt2DataOutput* dencrypt2(void* data, unsigned int len,unsigned int dencrypted_len, DWORD hash)
{
    char old_table[0x100],new_table[0x100],other[0x100];
    for (size_t i = 0; i < 0x100; i++)
        old_table[i] = i;
    Dencrypt2DataHead* head = (Dencrypt2DataHead*)data;
    if (head->sign != 0xFF435031)
    {
        cout << "Errod! 0xFF435031" << endl;
        return nullptr;
    }
    if (head->size> 0x20000000u)
    {
        cout << "Error! 0x20000000" << endl;
        return nullptr;
    }
  
    Dencrypt2DataOutput* Output = new Dencrypt2DataOutput();
    Output->len = dencrypted_len;
    Output->data = new BYTE[dencrypted_len + 1];
    BYTE* outputbuff = Output->data;
    BYTE* datapos = (BYTE*)data + sizeof(Dencrypt2DataHead);
    BYTE* data_start = datapos;
    BYTE* data_end = (BYTE*)data + len;
    BYTE chr;
    int t_pos;
    int size;
    while (data_start < data_end)
    {
        chr = *data_start;
        datapos = data_start + 1;
        memcpy(new_table, old_table, 0x100);
        t_pos = 0;
        while (1)
        {
            if (chr > 0x7Fu)
            {
                t_pos += chr - 127;
                chr = 0;
            }
            if (t_pos > 0xFF)
            {
                break;
            }
            for (size_t i = 0; i < chr + 1; i++)
            {
                new_table[t_pos] = *datapos++;
                if (t_pos != (unsigned __int8)new_table[t_pos])
                {
                    other[t_pos] = *datapos++;
                }
                ++t_pos;
            }
            if (t_pos > 0xFF)
                break;
            chr = *datapos++;
        }
        if ((head->isWordType & 1) == 1)
        {
            size = *(WORD*)datapos;
            data_start = (datapos + 2);
        }
        else
        {
            size = *(DWORD*)datapos;
            data_start = (datapos + 4);
        }
        stack<BYTE> stack; // unsigned char!
        while (1)
        {
            BYTE result;
            if (stack.size())
            {
                result = stack.top();
                stack.pop();
            }
            else
            {
                if (!size)
                {
                    break;
                }
                size--;
                result = *data_start;
                data_start++;
            }
            if (result == (BYTE)new_table[result])
            {
                *outputbuff = result;
                outputbuff++;
            }
            else
            {
                stack.push(other[result]);
                stack.push(new_table[result]);
            }
        }
    }
    return Output;
}
void DencryptFileName(void* data,int character_count,DWORD hash)
{
    int key = ((hash >> 0x10) & 0xFFFF) ^ hash;
    key = character_count ^ 0x3E13 ^ key ^ (character_count * character_count);
    DWORD ebx = key;
    DWORD ecx;
    WORD* datapos = (WORD*)data;
    for (size_t i = 0; i < character_count; i++)
    {
        ebx = ebx << 3;
        ecx = (ebx + i + key) & 0xFFFF;
        ebx = ecx;
        *datapos = (*datapos ^ ebx) & 0xFFFF;
        datapos++;
    }
}
DWORD* dencrypt3_hash(int hashlen,int datalen,void* filename,int character_count,DWORD Hash)
{
    DWORD key1 = 0x85F532;
    DWORD key2 = 0x33F641; 
    WORD* character = (WORD*)filename; // æŒ‡å‘æ–‡ä»¶å
    size_t i = 0;
    int v5 = character_count;
    int v6 = v5;
    do{
        key1 = key1 + (*character << (i & 7));
        key2 ^= key1;
        i++;
        v6--;
        character++;
    }while(v6);
    DWORD key3 = 9*((key2+(Hash^(7*(datalen&0xFFFFFF)+datalen+key1+(key1^datalen^0x8F32DC))))&0xFFFFFF);
    //
    QWORD a3 = key3;
    DWORD* result = new DWORD[hashlen];
    for (size_t i = 0; i < hashlen; i++)
    {
		a3 = (0x8DF21431 * __PAIR64__(a3 ^ 0x8DF21431, a3 ^ 0x8DF21431)) >> 32;
        *(result+i) = a3;
    }
    return result;
}
void dencrypt3(void* data,int len, void* filekey)
{
    //0x34ç›¸å½“äº4å­—èŠ‚æ•°æ®+0xD
    DWORD key1 = (*((DWORD*)filekey + 0xD) & 0xF) << 3;
    BYTE* datapos = (BYTE*)data, * fkey = (BYTE*)filekey;
    __m64 mm7 = *((__m64*)filekey + 0x3); //è¿™é‡Œ0x3ç›¸å½“äºBYTEçš„0x18
    __m64 mm6, mm0, mm1;
    for (size_t i = 0; i < len >>3; i++)
    {
        mm6 = *(__m64*)(fkey + key1);
        mm7 = _m_pxor(mm7, mm6);
        mm7 = _m_paddd(mm7, mm6);
        mm0 = *(__m64*)datapos;
        mm0 = _m_pxor(mm0, mm7);
        mm1 = mm0;
        *(__m64*)datapos = mm0;
        mm7 = _m_paddb(mm7, mm1);
        mm7 = _m_pxor(mm7, mm1);
        mm7 = _m_pslldi(mm7, 0x1);
        mm7 = _m_paddw(mm7, mm1);
        datapos += 8;
        key1 = (key1 + 8) & 0x7F;
    }
    _m_empty();
    return;
}
BYTE* dencypt4_keyfilehash(void* data,int len)
{
    int* keyfilehash = new int[0x100];
    int* keyfilehash_pos = keyfilehash;
    for (size_t i = 0; i < 0x100; i++)
    {
        if (i % 3 ==0)
        {
            *keyfilehash_pos = (i + 3u) * (i + 7u);
        }
        else
        {
            *keyfilehash_pos = -(i + 3u) * (i + 7u);
        }
        keyfilehash_pos++;
    }
    int key1 = *(BYTE*)((BYTE*)data + 0x31);
    key1 = (key1 % 0x49) + 0x80;
    int key2 = *(BYTE*)((BYTE*)data + 0x1E + 0x31);
    key2 = (key2 % 7) + 7;
    BYTE* keyfilehash_pos_byte = (BYTE*)keyfilehash;
    for (size_t i = 0; i < 0x400; i++)
    {
        key1 = (key1 + key2) % len;
        *keyfilehash_pos_byte ^= *(BYTE*)((BYTE*)data + key1);
        keyfilehash_pos_byte++;
    }
    return (BYTE*)keyfilehash;
}
DWORD* dencrypt4_hash(int hashlen, int datalen, void* filename, int character_count, DWORD hash)
{
    DWORD key1 = 0x86F7E2; //ebx
    DWORD key2 = 0x4437F1; //esi
    WORD* character = (WORD*)filename;
    for (size_t i = 0; i < character_count; i++)
    {
        key1 = key1 + (*character << (i & 7));
        key2 ^= key1;
        character++;
    }
    DWORD key3 = (datalen ^ key1 ^ 0x56E213) + key1 + datalen; //eax
    int key4 = (datalen & 0xFFFFFF) * 0xD; //edx
    key3 += key4;
    key3 ^= hash;
    key3 = ((key3 + key2) & 0xFFFFFF) * 0xD;
    unsigned long long rax = key3;
    DWORD* result = new DWORD[hashlen];
    for (size_t i = 0; i < hashlen; i++)
    {
        rax = (unsigned long long)(rax ^ 0x8A77F473u) * (unsigned long long)0x8A77F473u;
        rax = ((rax & 0xFFFFFFFF00000000) >> 32) + (rax & 0xFFFFFFFF);
        rax = rax & 0xFFFFFFFF;
        result[i] = rax;
    }
    return result;
}
void dencrypt4(void* data, int len, void* filekey,void* keyfilehash)
{
	DWORD key1 = (*((BYTE*)filekey + 0x20) & 0xD)*8; // v3 = 8 * (v12 & 0xD); filekeyä½œä¸ºesp?  v12:[esp+20h]
    BYTE* datapos = (BYTE*)data, * fkey = (BYTE*)filekey,* keyfilekey = (BYTE*)keyfilehash; // keyfilekey: å¦ä¸€å¼ hashè¡¨
    __m64 mm7 = *((__m64*)filekey + 0x3); //è¿™é‡Œ0x3ç›¸å½“äºBYTEçš„0x18
    __m64 mm6, mm0, mm1,mm5;
    for (size_t i = 0; i < len >> 3; i++)
    {
        mm6 = *(__m64*)(fkey + ((key1 & 0xF) << 3));
        mm5 = *(__m64*)(keyfilekey + ((key1 & 0x7F) << 3));
        mm6 = _m_pxor(mm6, mm5);
        mm7 = _m_pxor(mm7, mm6);
        mm7 = _m_paddd(mm7, mm6);
        mm0 = *(__m64*)datapos;
        mm0 = _m_pxor(mm0, mm7);
        mm1 = mm0;
        *(__m64*)datapos = mm0;
        mm7 = _m_paddb(mm7, mm1);
        mm7 = _m_pxor(mm7, mm1);
        mm7 = _m_pslldi(mm7, 0x1);
        mm7 = _m_paddw(mm7, mm1);
        datapos += 8;
        key1 = (key1 + 1) & 0x7F;
    }
    _m_empty();
    return;
}
FILE* WideChar_CreateFile(const wchar_t* filename) // å»ºæ–‡ä»¶(åŒ…æ‹¬dir)
{
    wchar_t* pos = (wchar_t*)filename;
    while (1)
    {
        pos = wcschr(pos, '\\');
        if (pos == nullptr)
        {
            break;
        }
        wchar_t* dir = new wchar_t[pos - filename + 1]();
        wcsncpy(dir, filename, pos - filename);
        _wmkdir(dir);
        pos++;
        delete dir;
    }
    FILE* hfile = _wfopen(filename, L"wb");
    return hfile;
}
int main()
{
	ios::sync_with_stdio(false);
	cout<<"Please Input The route of datax.pack:\n";
    string filename;
    cin >> filename;
    FILE* hfile;
    hfile = fopen(filename.c_str(), "rb");
    _fseeki64(hfile, 0, 2);
    fpos_t file_size = _ftelli64(hfile);
    //è¯»å–filepackå¤´
    _fseeki64(hfile, file_size - 0x1C, 0); // è¯»å–æœ€å0x1Cä¸ªå­—èŠ‚
    FilePackVer* filepacker = new FilePackVer();
    fread(filepacker, 0x1C,1 , hfile);
    if (string(filepacker->sign) != "FilePackVer3.1\x00\x00")
    {
        cout << "FilePackVer Error!" << endl;
        return 0;
    }
    //è¯»å–HashData
    HashData *hashdat = new HashData();
    _fseeki64(hfile,file_size-0x440,0); // åˆ©ç”¨å‰é¢çš„FilePackç»“æ„ä½“å‡å»0x440çš„offsetå°±æ˜¯HashDataç»“æ„ä½“ä½ç½®
    fread(hashdat,1,0x440,hfile);
    //æ•°æ®çš„è®¾ç½®
    if (hashdat->Unkown > 8 || hashdat->Unkown < 0)
    {
        hashdat->Unkown = 0;
    }
    DWORD hash = Tohash(&hashdat->data,0x100) & 0x0FFFFFFF;
    //è§£ç ç­¾å
    dencrypt(&hashdat->sign, 0x20, hash);
    if (strncmp(hashdat->sign,"8hr48uky,8ugi8ewra4g8d5vbf5hb5s6",0x20))
    {
        cout << "HashData Error!" << endl;
        return 0;
    }
    //å¼€å§‹è§£å¯†æ–‡ä»¶
    DWORD64 entry = ((long long)filepacker->entry_high << 32) + (long long)filepacker->entry_low; // cdq
    BYTE* keyfilehash = nullptr;
    for (size_t i = 0; i < filepacker->filecount; i++)
    {
        _fseeki64(hfile, entry, 0);
        WORD character_count;
        fread(&character_count, 2, 1, hfile);
        wchar_t* name = new wchar_t[character_count + 1]();
        //å› ä¸ºUTF16å­—èŠ‚æ•°æ˜¯ASCIIçš„ä¸¤å€ï¼Œæ‰€ä»¥è¦ä¹˜2
        fread(name, 1, 2 * character_count, hfile);
        //è§£å¯†æ–‡ä»¶å
        DencryptFileName(name, character_count, hash);
        FileEntry *fentry = new FileEntry();
        fread(fentry, 1, 0x1C, hfile);
        entry = _ftelli64(hfile);
        //æ–‡ä»¶è¯»å–
        char* filedata = new char[fentry->size];
        _fseeki64(hfile, ((long long)fentry->offset_hight << 32) + (long long)fentry->offset_low, 0);
        fread(filedata, fentry->size, 1, hfile);
  
        //è§£å¯†æ–‡ä»¶
        DWORD* filehash = nullptr;
        if (fentry->EncryptType == 1)
        {
            filehash = dencrypt3_hash(0x40, fentry->size, name, character_count, hash);
            dencrypt3(filedata, fentry->size, filehash);
            if (wcsncmp(name, L"pack_keyfile_kfueheish15538fa9or.key", character_count) == 0)
            {
                keyfilehash = dencypt4_keyfilehash(filedata, fentry->size);
            }
        }
        else if(fentry->EncryptType == 2)
        {
            filehash = dencrypt4_hash(0x40, fentry->size, name, character_count, hash);
            dencrypt4(filedata, fentry->size, filehash, keyfilehash);
        }
        Dencrypt2DataOutput* Output = nullptr;
        if (fentry->isCompressed)
        {
            Output = dencrypt2(filedata, fentry->size, fentry->dencrypted_size, hash);
        }
        else
        {
            Output = new Dencrypt2DataOutput();
            Output->data = (BYTE*)filedata;
            Output->len = fentry->dencrypted_size;
        }
        //ä¿å­˜æ–‡ä»¶
        wstring filename = wstring(name);
        filename = L"ExtractData\\" + filename;
        FILE* hOut = WideChar_CreateFile(filename.c_str());
        std::fwrite(Output->data, Output->len, 1, hOut);
        std::fclose(hOut);
        delete fentry, name, filedata, filehash, Output;
    }
  
    std::fclose(hfile);
}


```

# å†™åœ¨æœ€å
52pjé‚£ç¯‡ç¥ä½œå¯¹äºæ²¡æ¥è§¦è¿‡è¿™ç§ç±»å‹çš„é€†å‘æ¥è¯´è¿˜æ˜¯æŒºæœ‰éš¾åº¦çš„ æ— è®ºæ˜¯x32dbgçš„è°ƒè¯•æŠ€å·§è¿˜æ˜¯ä¸€äº›æ•°æ®æ•æ„Ÿä»¥åŠå¯¹ç»“æ„ä½“çš„é‡è§†éƒ½éœ€è¦æ—¶é—´æ¥é€‚åº”
å¸Œæœ›æˆ‘çš„å·¥ä½œèƒ½ç»™çœ‹åˆ°è¿™ç¯‡æ–‡ç« çš„ä½ å¸¦æ¥ä¸€ç‚¹å¯å‘

å¯ä»¥è¯´ä¸‡åé•œæ˜¯æˆ‘æœ€æ—©æ¥è§¦åˆ°é€†å‘å·¥ç¨‹çš„ä¸€ä¸ªå¥‘æœº
å»å¹´æš‘å‡æ‰¾ä¸‡åé•œç©çš„æ—¶å€™æƒ³è¦è§£å‡ºé‡Œé¢çš„CG ç½‘ä¸Šçš„Extractoréƒ½è§£ä¸å‡ºæ¥
å…œå…œè½¬è½¬å°±æ‰¾åˆ°äº†52pjè¿™ç¯‡ç¥ä½œ~
å»å¹´11æœˆåˆä¹Ÿå°è¯•è¿‡å¼€å§‹é€† ä½†é€†ä¸äº†ä¸€ç‚¹...
ç°åœ¨åˆè¿‡äº†å‡ ä¸ªæœˆ åˆå­¦ä¹ åˆ°äº†æ›´å¤šçŸ¥è¯†/é€†å‘ç»éªŒ ç£•ç£•ç»Šç»Šä¹Ÿèƒ½å°†å¼•æ“æ‘¸ç´¢ä¸ªå¤§æ¦‚
çŠ¹è®°å‡ ä¸ªæœˆå‰è¿˜å°†é€†å‡ºä¸‡åé•œ5ä½œä¸ºé€†å‘çš„ç»ˆæç›®æ ‡(ğŸ¤£) çœ‹æ¥ç›®æ ‡è¿˜å¯ä»¥æ›´å¤§å‘~

ä¹Ÿè®¸è¿™å°±æ˜¯é€†å‘å·¥ç¨‹çš„é­…åŠ›æ‰€åœ¨å§~ èƒ½è®©æˆ‘èŠ±æ•´æ•´ä¸€ä¸ªå‘¨æœ« ä¸€ç›´åšä¸€ä»¶äº‹
å½“è·Ÿç€ä¸€æ¡æ¡æ±‡ç¼–æŠ½ä¸å‰¥èŒ§ è¿˜åŸå„ç§ç»“æ„ä½“ æ‰¾åˆ°å„ä¸ªå…³é”®ç®—æ³•æ—¶ é‚£ç§å–œæ‚¦æ˜¯éš¾ä»¥è¨€è¡¨çš„
å¸Œæœ›èƒ½ä¸€ç›´å¸¦ç€è¿™ç§çƒ­å¿±ç»§ç»­å­¦ä¹ é€†å‘å·¥ç¨‹ 

**`<<< Reversing <<<`**